<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeoRanks ‚Äî Leaderboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/game-modes.css" />
  
  <!-- Shared Page Styles -->
  <link rel="stylesheet" href="css/page.css">
  
  <style>
    /* ========================================
       BODY & PAGE LAYOUT
    ======================================== */
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .leaderboard-page-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    /* ========================================
       LEADERBOARD SPECIFIC STYLES
    ======================================== */
    .leaderboard-container {
      max-width: 720px;
      margin: 120px auto 60px;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      text-align: center;
      overflow: visible;
      opacity: 0;
      animation: fadeInContainer 0.5s ease-out forwards;
    }
    
    @keyframes fadeInContainer {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .leaderboard-container h1 {
      opacity: 0;
      animation: fadeIn 0.5s ease-out 0.2s forwards;
    }
    
    .page-title {
      font-size: 2.4rem;
      font-weight: 700;
      color: #0d315a;
      margin-bottom: 8px;
    }
    
    .page-title-text {
      background: #0d315a;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .search-bar-wrapper {
      max-width: 600px;
      margin: 20px auto;
      position: relative;
      box-sizing: border-box;
      opacity: 0;
      animation: fadeIn 0.5s ease-out 0.4s forwards;
      z-index: 100;
    }

    .search-bar-wrapper input {
      width: 100%;
      padding: 18px 24px;
      font-size: 1.1rem;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      cursor: pointer;
      box-sizing: border-box;
    }

    .search-bar-wrapper input:focus {
      outline: none;
      border-color: rgba(255,255,255,0.6);
      transform: translateY(-2px);
      box-shadow: 0 12px 48px rgba(0,0,0,0.2);
    }

    .search-bar-wrapper input:hover {
      border-color: rgba(255,255,255,0.5);
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }

    .search-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 8px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 12px 48px rgba(0,0,0,0.2);
      max-height: 400px;
      overflow-y: auto;
      z-index: 10000;
      display: none;
    }

    .search-dropdown.active {
      display: block;
      animation: dropdownSlide 0.3s ease-out;
    }

    @keyframes dropdownSlide {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .search-dropdown-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 20px;
      cursor: pointer;
      transition: background 0.2s ease;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .search-dropdown-item:last-child {
      border-bottom: none;
    }

    .search-dropdown-item:hover {
      background: rgba(102,126,234,0.08);
    }

    .search-dropdown-item img {
      width: 60px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .search-dropdown-text {
      flex: 1;
      font-weight: 500;
      color: #333;
      font-size: 1rem;
    }

    .search-dropdown::-webkit-scrollbar {
      width: 8px;
    }

    .search-dropdown::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.05);
      border-radius: 10px;
    }

    .search-dropdown::-webkit-scrollbar-thumb {
      background: rgba(102,126,234,0.3);
      border-radius: 10px;
    }

    .search-dropdown::-webkit-scrollbar-thumb:hover {
      background: rgba(102,126,234,0.5);
    }

    .no-results {
      padding: 20px;
      text-align: center;
      color: #666;
      font-size: 0.95rem;
    }

    .mode-toggle {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 20px 0;
      opacity: 0;
      animation: fadeIn 0.5s ease-out 0.6s forwards;
    }

    .mode-btn {
      padding: 12px 28px;
      background: white;
      border: 2px solid rgba(102, 126, 234, 0.15);
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
      color: #0d315a;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .mode-btn.active {
      background: linear-gradient(135deg, #ff9770 0%, #ff6f61 100%);
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 16px rgba(255, 151, 112, 0.3);
    }

    .mode-btn:hover:not(.active) {
      background: rgba(102, 126, 234, 0.08);
      border-color: rgba(102, 126, 234, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.15);
    }

    .date-selector {
      margin: 20px 0;
      display: none;
    }

    .date-selector.active {
      display: block;
    }

    .date-selector select {
      padding: 10px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      background: white;
      cursor: pointer;
    }

    .leaderboard-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
      margin-top: 1rem;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      opacity: 0;
      animation: fadeIn 0.5s ease-out 0.8s forwards;
      position: relative;
      z-index: 1;
    }

    .leaderboard-table th {
      font-weight: 600;
      padding: 1rem;
      font-size: 1.2rem;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
      color: #0d315a;
      border-bottom: 2px solid rgba(102, 126, 234, 0.15);
    }

    .leaderboard-table td {
      padding: 1.1rem 0.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      font-size: 1.25rem;
      text-align: center;
      background: white;
      transition: background 0.2s ease;
    }

    .leaderboard-table tbody tr:hover td {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.04), rgba(118, 75, 162, 0.04));
    }

    .leaderboard-table tbody tr:last-child td {
      border-bottom: none;
    }

    .leaderboard-table tbody tr td[colspan] {
      text-align: center !important;
      padding: 2rem 1rem;
    }

    .leaderboard-table th:nth-child(1), .leaderboard-table td:nth-child(1) { width: 20%; }
    .leaderboard-table th:nth-child(2), .leaderboard-table td:nth-child(2) { width: 20%; }
    .leaderboard-table th:nth-child(3), .leaderboard-table td:nth-child(3) { width: 40%; }
    .leaderboard-table th:nth-child(4), .leaderboard-table td:nth-child(4) { width: 20%; }

    .leaderboard-table th:first-child { border-top-left-radius: 12px; }
    .leaderboard-table th:last-child { border-top-right-radius: 12px; }
    .leaderboard-table tr:last-child td:first-child { border-bottom-left-radius: 12px; }
    .leaderboard-table tr:last-child td:last-child { border-bottom-right-radius: 12px; }

    .avatar-wrapper {
      position: relative;
      display: inline-block;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }

    .avatar-wrapper img.avatar {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      border: 2px solid rgba(102, 126, 234, 0.15);
    }

    .avatar-wrapper img.premium-badge {
      position: absolute;
      bottom: -4px;
      right: -4px;
      width: 22px;
      height: 22px;
    }

    .leaderboard-avatar {
      user-select: none;
      -webkit-user-drag: none;
      pointer-events: none;
    }

    .leaderboard-rank {
      font-weight: bold;
      font-size: 1.25rem;
    }

    .leaderboard-rank:has(> .medal) {
      line-height: 1;
    }

    .medal {
      font-size: 1.75rem;
      display: inline-block;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
    }

    .back-home {
      margin-top: 2.2rem;
      display: inline-block;
      padding: 0.9rem 1.8rem;
      border-radius: 10px;
      border: none;
      color: white;
      font-size: 1.2rem;
      font-weight: 600;
      text-decoration: none;
      background: linear-gradient(135deg, #ff9770, #ff6f61);
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .leaderboard-container { 
        margin: 100px 1rem 40px; 
        padding: 1.5rem 1rem;
        max-width: calc(100% - 2rem);
      }
      .mode-toggle { flex-wrap: wrap; gap: 8px; }
      .mode-btn { padding: 8px 16px; font-size: 0.9rem; }
      .avatar-wrapper, .avatar-wrapper img.avatar { width: 50px; height: 50px; }
      .avatar-wrapper img.premium-badge { width: 18px; height: 18px; bottom: -2px; right: -2px; }
      .leaderboard-table th { font-size: 1rem; padding: 0.75rem 0.5rem; }
      .leaderboard-table td { font-size: 1rem; padding: 0.75rem 0.25rem; }
      .medal { font-size: 1.5rem; }
      .back-home { padding: 0.75rem 1.5rem; font-size: 1rem; }
    }

    @media (max-width: 480px) {
      .leaderboard-container {
        margin: 90px 0.75rem 30px;
        padding: 1.25rem 0.75rem;
        max-width: calc(100% - 1.5rem);
      }
    }
  </style>
</head>
<body>

<!-- ========== HEADER ========== -->
<header class="home-glass-header">
  <div class="logo-header">
    <a href="index.html" class="logo-link">
      <img src="assets/logo.png" alt="GeoRanks Logo" />
    </a>
  </div>
  <div class="menu-icon" id="menuToggle">
    <span></span>
    <span></span>
    <span></span>
  </div>
</header>

<!-- ========== HAMBURGER MENU ========== -->
<div class="menu-overlay" id="menuOverlay">
  <div class="menu-panel">
    <h2>Menu</h2>
    
    <button class="menu-btn menu-daily-challenge" onclick="window.location.href='daily-challenge.html'" id="dailyChallengeMenuBtn">
  <div class="daily-bg" id="dailyChallengeBg"></div>
  <div class="daily-overlay"></div>
  <div class="daily-content">
    <h3 class="daily-title">üìÖ Daily Challenge</h3>
    <span class="daily-category" id="dailyChallengeCategory">Loading...</span>
  </div>
</button>
    
    <button class="menu-btn" onclick="window.location.href='index.html'">üè† Home</button>
    <button class="menu-btn" onclick="window.location.href='categories.html'">üéÆ Categories</button>
    <button class="menu-btn menu-btn-account" onclick="window.location.href='account.html'">üë§ Account</button>
    <button class="menu-btn" onclick="window.location.href='stats.html'">üìä My Stats</button>
    <button class="menu-btn" onclick="window.location.href='how-to-play.html'">üí° How to Play</button>
    <button class="menu-btn" onclick="location.href='feedback.html'">üí¨ Feedback</button>
    <button class="menu-btn" onclick="location.href='contact.html'">üì© Contact Us</button>
    <button class="menu-btn" onclick="location.href='about.html'">üåç About Us</button>
    <button class="menu-btn upgrade-access-btn" onclick="window.location.href='premium.html'">üîì Unlock All Categories</button>
    <button class="menu-close-x" id="closeMenu">√ó</button>
  </div>
</div>

<!-- ========== MAIN CONTENT WRAPPER ========== -->
<div class="leaderboard-page-wrapper">

<!-- ========== LEADERBOARD CONTENT ========== -->
<div class="leaderboard-container">
  <h1 class="page-title">üèÜ <span class="page-title-text">Leaderboard</span></h1>

  <!-- Mode Toggle -->
  <div class="mode-toggle">
    <button class="mode-btn active" data-mode="daily-challenge">Daily</button>
    <button class="mode-btn" data-mode="classic">Classic</button>
    <button class="mode-btn" data-mode="top10">Top 10</button>
    <button class="mode-btn" data-mode="vs">VS</button>
  </div>

  <!-- Date Selector -->
  <div class="date-selector" id="dateSelector">
    <label for="dateDropdown">Select Date:</label>
    <select id="dateDropdown"></select>
  </div>

  <!-- Category Search Bar -->
  <div class="search-bar-wrapper" id="categorySearchWrapper">
    <input type="text" id="categorySearchInput" placeholder="üîç Search Categories..." />
    <div class="search-dropdown" id="searchDropdown"></div>
  </div>

  <!-- Daily Challenge Title -->
  <h3 id="dailyChallengeTitle" style="display: none; margin: 20px 0; font-size: 1.3rem;"></h3>

  <table class="leaderboard-table">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Avatar</th>
        <th>Username</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody id="leaderboardBody">
      <tr><td colspan="4">Loading...</td></tr>
    </tbody>
  </table>

  <a href="index.html" class="back-home">Return Home</a>
</div>

</div>
<!-- ========== END MAIN CONTENT WRAPPER ========== -->

<!-- ========== FOOTER ========== -->
<footer class="home-footer">
  <div class="footer-socials">
  </div>
</footer>

<!-- ========== JAVASCRIPT ========== -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const menuToggle = document.getElementById('menuToggle');
  const menuOverlay = document.getElementById('menuOverlay');
  const closeMenu = document.getElementById('closeMenu');
  let scrollPosition = 0;

  if (menuToggle && menuOverlay) {
    menuToggle.addEventListener('click', () => {
      scrollPosition = window.pageYOffset;
      document.body.classList.add('menu-open');
      document.body.style.top = `-${scrollPosition}px`;
      menuOverlay.classList.add('active');
    });

    function closeMenuHandler() {
      document.body.classList.remove('menu-open');
      document.body.style.top = '';
      window.scrollTo(0, scrollPosition);
      menuOverlay.classList.remove('active');
    }

    closeMenu?.addEventListener('click', closeMenuHandler);

    menuOverlay.addEventListener('click', (e) => {
      if (e.target === menuOverlay) {
        closeMenuHandler();
      }
    });
  }
});
</script>

</body>
</html>

<!-- ========================================
     SEARCH DROPDOWN JAVASCRIPT
======================================== -->
<script type="module">
  import { supabase } from './js/supabase-client.js';

  const searchInput = document.getElementById('categorySearchInput');
  const searchDropdown = document.getElementById('searchDropdown');

  const displayNameMap = {
    'temperature': 'Highest Temperature', 'precipitation': 'Rainfall', 'altitude': 'Highest Altitude',
    'gdp': 'GDP Per Capita', 'population': 'Population', 'forest': 'Forest Cover',
    'coastline': 'Longest Coastline', 'olympic': 'Olympic Medals', 'cuisine': 'Cuisine',
    'worldcup': 'World Cup Trophies', 'landmass': 'Land Mass', 'crimerate': 'Crime Rate',
    'happiness': 'Happiness', 'passport': 'Passport Strength', 'beer': 'Beer Consumption',
    'nobelprize': 'Nobel Prize Winners', 'michelin': 'Michelin Restaurants', 'bigmac': 'BigMac Index',
    'lifeexpectancy': 'Life Expectancy', 'tourism': 'Tourist Visits', 'marriageage': 'Marriage Age',
    'sexratio': 'Gender Ratio', 'tallestbuilding': 'Tallest Building', 'density': 'Population Density',
    'carexports': 'Car Exports', 'militarypersonel': 'Military Personnel', 'rent': 'Rent Prices',
    'poorestgdp': 'Poorest Countries', 'university': 'Universities', 'volcano': 'Volcanoes',
    'flamingo': 'Flamingos', 'disasterrisk': 'Natural Disasters', 'longestriver': 'Longest River',
    'renewableenergy': 'Renewable Energy', 'millionaires': 'Millionaires', 'gm': 'Chess Grandmasters'
  };

  const imageMap = { temperature: 'hightemp', precipitation: 'rainfall' };

  function formatCategoryName(name) {
    return name.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
  }

  let allCategories = [];

  // Load categories
  async function loadCategories() {
    const { data: categories } = await supabase.from('categories').select('*').order('name');
    if (categories) {
      allCategories = categories.map(cat => ({
        category: cat.name,
        display: displayNameMap[cat.name.toLowerCase()] || formatCategoryName(cat.name),
        image: imageMap[cat.name.toLowerCase()] || cat.name.toLowerCase() + '.jpg'
      })).sort((a, b) => a.display.localeCompare(b.display));
    }
  }

  loadCategories();

  // Clear input and show all categories when clicked
  searchInput?.addEventListener('click', () => {
    searchInput.value = '';
    renderDropdown(allCategories);
  });

  // Show all categories when focused
  searchInput?.addEventListener('focus', () => {
    if (searchInput.value.trim().length === 0) {
      renderDropdown(allCategories);
    }
  });

  // Filter as user types
  searchInput?.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    
    if (query.length === 0) {
      renderDropdown(allCategories);
      return;
    }

    const filtered = allCategories.filter(cat => 
      cat.display.toLowerCase().includes(query)
    );

    if (filtered.length === 0) {
      searchDropdown.innerHTML = '<div class="no-results">No categories found</div>';
      searchDropdown.classList.add('active');
      return;
    }

    renderDropdown(filtered);
  });

  function renderDropdown(categories) {
    searchDropdown.innerHTML = categories.map(cat => `
      <div class="search-dropdown-item" data-category="${cat.category}" data-display="${cat.display}">
        <img src="images/categories/${cat.image}" alt="${cat.display}" />
        <div class="search-dropdown-text">${cat.display}</div>
      </div>
    `).join('');

    searchDropdown.classList.add('active');

    searchDropdown.querySelectorAll('.search-dropdown-item').forEach(item => {
      item.addEventListener('click', () => {
        const category = item.dataset.category;
        const display = item.dataset.display;
        
        searchInput.value = display; // Set the display name in the search bar
        searchDropdown.classList.remove('active');

        if (window.currentMode === 'classic' || window.currentMode === 'top10' || window.currentMode === 'vs') {
          window.loadLeaderboard(category);
        }
        window.currentCategory = category;
      });
    });
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
      searchDropdown.classList.remove('active');
    }
  });
</script>

<!-- ========================================
     LEADERBOARD JAVASCRIPT
======================================== -->
<script type="module">
  import { supabase } from './js/supabase-client.js';

  const leaderboardBody = document.getElementById("leaderboardBody");
  const dateDropdown = document.getElementById("dateDropdown");
  const dateSelector = document.getElementById("dateSelector");
  const categorySearchWrapper = document.getElementById("categorySearchWrapper");
  const dailyChallengeTitle = document.getElementById("dailyChallengeTitle");
  
  let currentMode = 'daily-challenge';
  let currentDate = null;
  let currentCategory = null;

  const displayNameMap = {
    'hightemp': 'Highest Temperature', 'rainfall': 'Annual Rainfall', 'altitude': 'Highest Altitude',
    'gdp': 'GDP Per Capita', 'population': 'Population', 'forest': 'Forest Coverage',
    'coastline': 'Coastline Length', 'olympic': 'Olympic Medals', 'cuisine': 'Cuisine Popularity',
    'worldcup': 'World Cup Wins', 'landmass': 'Landmass', 'crimerate': 'Crime Rate',
    'happiness': 'Happiness Index', 'passport': 'Passport Power', 'beer': 'Beer Consumption',
    'nobelprize': 'Nobel Prizes', 'michelin': 'Michelin Restaurants', 'bigmac': 'BigMac Index',
    'lifeexpectancy': 'Life Expectancy', 'tourism': 'Tourist Visits', 'marriageage': 'Marriage Age',
    'sexratio': 'Gender Ratio', 'tallestbuilding': 'Tallest Building', 'density': 'Population Density',
    'carexports': 'Car Exports', 'militarypersonel': 'Military Personnel', 'rent': 'Rent Prices',
    'poorestgdp': 'Poorest Countries', 'university': 'Universities', 'volcano': 'Volcanoes',
    'flamingo': 'Flamingos', 'disasterrisk': 'Natural Disasters', 'longestriver': 'Longest River',
    'renewableenergy': 'Renewable Energy', 'millionaires': 'Millionaires', 'gm': 'Chess Grandmasters'
  };

  function formatCategoryName(name) {
    return name.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
  }

  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentMode = btn.dataset.mode;
      
      if (currentMode === 'daily-challenge') {
        dateSelector.classList.add('active');
        categorySearchWrapper.style.display = 'none';
        dailyChallengeTitle.style.display = 'block';
        populateDateDropdown();
        if (currentDate) loadDailyChallengeLeaderboardForDate(currentDate);
      } else {
        dateSelector.classList.remove('active');
        categorySearchWrapper.style.display = 'block';
        dailyChallengeTitle.style.display = 'none';
        if (currentCategory) {
          loadLeaderboard(currentCategory);
          // Update search bar with current category name
          const displayName = displayNameMap[currentCategory.toLowerCase()] || formatCategoryName(currentCategory);
          document.getElementById("categorySearchInput").value = displayName;
        }
      }
    });
  });

  dateDropdown?.addEventListener('change', (e) => {
    currentDate = e.target.value;
    loadDailyChallengeLeaderboardForDate(currentDate);
  });

  function seededRandom(seed) {
    const x = Math.sin(seed) * 10000;
    return x - Math.floor(x);
  }

  function getDailyChallengeForDate(dateString) {
    const date = new Date(dateString + 'T00:00:00Z');
    const seed = date.getUTCFullYear() * 10000 + (date.getUTCMonth() + 1) * 100 + date.getUTCDate();
    
    const gameModes = ['classic', 'top10', 'vs'];
    const top10ValidCategories = ['population', 'gdp', 'landmass', 'altitude', 'forest', 'coastline',
      'passport', 'beer', 'nobelprize', 'hightemp', 'rainfall', 'crimerate', 'happiness','tourism',
      'michelin', 'bigmac', 'lifeexpectancy', 'marriageage', 'sexratio', 'tallestbuilding',
      'density', 'carexports', 'militarypersonel', 'rent', 'poorestgdp', 'university', 'volcano',
      'flamingo', 'disasterrisk', 'longestriver', 'renewableenergy', 'millionaires', 'gm'];
    const allCategories = ['population', 'gdp', 'landmass', 'altitude', 'forest', 'coastline',
  'olympic', 'worldcup', 'passport', 'beer', 'nobelprize', 'hightemp', 'rainfall',
  'crimerate', 'happiness', 'cuisine', 'tourism', 'michelin', 'bigmac', 'lifeexpectancy',
  'marriageage', 'sexratio', 'tallestbuilding', 'density', 'carexports',
  'militarypersonel', 'rent', 'poorestgdp', 'university', 'volcano',
  'flamingo', 'disasterrisk', 'longestriver', 'renewableenergy', 'millionaires', 'gm'];
    
    const modeIndex = Math.floor(seededRandom(seed) * gameModes.length);
    const selectedMode = gameModes[modeIndex];
    const validCategories = selectedMode === 'top10' ? top10ValidCategories : allCategories;
    const categoryIndex = Math.floor(seededRandom(seed + 1000) * validCategories.length);
    
    return { mode: selectedMode, category: validCategories[categoryIndex] };
  }

  async function loadDailyChallengeLeaderboardForDate(date) {
    leaderboardBody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
    if (!date) {
      leaderboardBody.innerHTML = '<tr><td colspan="4">‚ùå No date selected</td></tr>';
      return;
    }

    const dailyChallenge = getDailyChallengeForDate(date);
    const { CATEGORY_ID_MAP } = await import('./js/top10-categories-loader.js');
    const categoryId = CATEGORY_ID_MAP[dailyChallenge.category];
    
    if (!categoryId) {
      leaderboardBody.innerHTML = '<tr><td colspan="4">‚ùå Category not found</td></tr>';
      dailyChallengeTitle.textContent = '';
      return;
    }

    const modeNames = { classic: 'Classic', top10: 'Top 10', vs: 'VS' };
    const displayName = displayNameMap[dailyChallenge.category] || formatCategoryName(dailyChallenge.category);
    dailyChallengeTitle.textContent = `${modeNames[dailyChallenge.mode]} - ${displayName}`;

    const { data: scores, error } = await supabase
      .from("daily_challenge_scores")
      .select('score, user_id, users!fk_user(id, username, avatar_url, is_premium)')
      .eq("category_id", categoryId)
      .eq("played_date", date)
      .order("score", { ascending: false })
      .limit(20);

    if (error) {
      console.error('Error loading Daily Challenge scores:', error);
      leaderboardBody.innerHTML = '<tr><td colspan="4">‚ùå Error loading scores</td></tr>';
      return;
    }
    renderLeaderboard(scores || []);
  }

  function populateDateDropdown() {
    const today = new Date();
    dateDropdown.innerHTML = '';
    for (let i = 0; i < 30; i++) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      const dateStr = date.toISOString().split('T')[0];
      const displayDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      const option = document.createElement('option');
      option.value = dateStr;
      option.textContent = i === 0 ? `Today (${displayDate})` : displayDate;
      dateDropdown.appendChild(option);
    }
    currentDate = dateDropdown.value;
  }

  async function loadCategories() {
    try {
      const params = new URLSearchParams(window.location.search);
      const { data: categories } = await supabase.from("categories").select("*").order("name");
      if (!categories?.length) {
        console.warn('No categories loaded');
        return;
      }

      // Sort categories alphabetically by display name
      const sortedCategories = categories
        .map(cat => ({
          name: cat.name,
          display: displayNameMap[cat.name.toLowerCase()] || formatCategoryName(cat.name)
        }))
        .sort((a, b) => a.display.localeCompare(b.display));

      const initial = params.get("mode") || sortedCategories[0].name;
      currentCategory = initial;
      
      if (currentMode === 'classic' || currentMode === 'top10' || currentMode === 'vs') {
        categorySearchWrapper.style.display = 'block';
        dailyChallengeTitle.style.display = 'none';
        dateSelector.classList.remove('active');
        loadLeaderboard(initial);
        const displayName = displayNameMap[initial.toLowerCase()] || formatCategoryName(initial);
        document.getElementById("categorySearchInput").value = displayName;
      } else if (currentMode === 'daily-challenge') {
        categorySearchWrapper.style.display = 'none';
        dailyChallengeTitle.style.display = 'block';
        dateSelector.classList.add('active');
        populateDateDropdown();
        if (dateDropdown.value) {
          currentDate = dateDropdown.value;
          loadDailyChallengeLeaderboardForDate(currentDate);
        }
      }
    } catch (error) {
      console.error('Failed to load categories:', error);
      leaderboardBody.innerHTML = '<tr><td colspan="4">Failed to load leaderboard. Please refresh the page.</td></tr>';
    }
  }

  async function loadLeaderboard(categoryName) {
    leaderboardBody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
    currentCategory = categoryName;
    if (currentMode === 'classic') await loadClassicLeaderboard(categoryName);
    else if (currentMode === 'top10') await loadTop10BestLeaderboard(categoryName);
    else if (currentMode === 'vs') await loadVSLeaderboard(categoryName);
  }

  async function loadClassicLeaderboard(categoryName) {
    const { data: categoryData } = await supabase.from("categories").select("id").eq("name", categoryName).single();
    if (!categoryData) {
      leaderboardBody.innerHTML = '<tr><td colspan="4">‚ùå Category not found</td></tr>';
      return;
    }

    const { data: scores } = await supabase.from("category_scores")
      .select('score, user_id, users!inner(id, username, avatar_url, is_premium)')
      .eq("category_id", categoryData.id)
      .order("score", { ascending: false })
      .limit(20);
    renderLeaderboard(scores || []);
  }

  async function loadTop10BestLeaderboard(categoryName) {
    const { CATEGORY_ID_MAP } = await import('./js/top10-categories-loader.js');
    const categoryId = CATEGORY_ID_MAP[categoryName.toLowerCase()];
    if (!categoryId) {
      leaderboardBody.innerHTML = '<tr><td colspan="4">‚ùå Category not available for Top 10</td></tr>';
      return;
    }

    const { data: scores } = await supabase.from("top10_best_scores")
      .select('score, user_id, users!fk_user(id, username, avatar_url, is_premium)')
      .eq("category_id", categoryId)
      .order("score", { ascending: false })
      .limit(20);
    renderLeaderboard(scores || []);
  }

  async function loadVSLeaderboard(categoryName) {
    const { CATEGORY_ID_MAP } = await import('./js/top10-categories-loader.js');
    const categoryId = CATEGORY_ID_MAP[categoryName.toLowerCase()];
    if (!categoryId) {
      leaderboardBody.innerHTML = '<tr><td colspan="4">‚ùå Category not available for VS</td></tr>';
      return;
    }

    const { data: scores } = await supabase.from("vs_scores")
      .select('score, user_id, users!fk_user(id, username, avatar_url, is_premium)')
      .eq("category_id", categoryId)
      .order("score", { ascending: false });

    const bestScoresMap = new Map();
    scores?.forEach(score => {
      const existing = bestScoresMap.get(score.user_id);
      if (!existing || score.score > existing.score) bestScoresMap.set(score.user_id, score);
    });
    renderLeaderboard(Array.from(bestScoresMap.values()).sort((a, b) => b.score - a.score).slice(0, 20));
  }

  function renderLeaderboard(scores) {
    leaderboardBody.innerHTML = "";
    if (!scores || scores.length === 0) {
      leaderboardBody.innerHTML = '<tr><td colspan="4">üë§ No scores yet for this category</td></tr>';
      return;
    }

    scores.forEach((entry, index) => {
      const user = entry.users || {};
      const rankDisplay = index === 0 ? '<span class="medal">ü•á</span>' :
        index === 1 ? '<span class="medal">ü•à</span>' :
        index === 2 ? '<span class="medal">ü•â</span>' : `#${index + 1}`;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="leaderboard-rank">${rankDisplay}</td>
        <td>
          <div class="avatar-wrapper" style="width: 50px; height: 50px;">
            <img src="${user.avatar_url || 'assets/profile-icon.jpg'}" loading="lazy"
                 class="leaderboard-avatar avatar" style="width: 50px; height: 50px; border-radius: 50%;" />
            ${user.is_premium ? '<img src="assets/GeoRanksPremium.png" class="premium-badge" />' : ''}
          </div>
        </td>
        <td>${user.username || "Anonymous"}</td>
        <td>${entry.score}</td>
      `;
      leaderboardBody.appendChild(row);
    });
  }

  window.loadLeaderboard = loadLeaderboard;
  window.loadDailyChallengeLeaderboardForDate = loadDailyChallengeLeaderboardForDate;
  
  // Make these reactive - use getters/setters
  Object.defineProperty(window, 'currentMode', {
    get: () => currentMode,
    set: (value) => { currentMode = value; }
  });
  
  Object.defineProperty(window, 'currentDate', {
    get: () => currentDate,
    set: (value) => { currentDate = value; }
  });
  
  Object.defineProperty(window, 'currentCategory', {
    get: () => currentCategory,
    set: (value) => { currentCategory = value; }
  });

  // Initialize with timeout protection
  const initTimeout = setTimeout(() => {
    console.warn('‚è±Ô∏è Leaderboard initialization timed out after 5s');
    leaderboardBody.innerHTML = '<tr><td colspan="4">Loading is taking longer than expected. Please refresh the page.</td></tr>';
  }, 5000); // 5 second timeout for leaderboard (needs more time for database queries)

  loadCategories()
    .then(() => {
      clearTimeout(initTimeout);
      console.log('‚úÖ Leaderboard loaded successfully');
    })
    .catch(err => {
      clearTimeout(initTimeout);
      console.error('‚ùå Leaderboard initialization failed:', err);
      leaderboardBody.innerHTML = '<tr><td colspan="4">Failed to load leaderboard. Please refresh the page.</td></tr>';
    });
</script>

<!-- ========================================
     ACCOUNT/PREMIUM BUTTON REMOVAL
======================================== -->
<script type="module">
  import { supabase } from './js/supabase-client.js';
  
  // NON-BLOCKING: Use .then() instead of await
  supabase.auth.getSession()
    .then(async ({ data: { session } }) => {
      if (session?.user) {
        const { data: profile } = await supabase.from('users').select('is_premium').eq('id', session.user.id).single();
        if (profile?.is_premium) document.querySelectorAll('.upgrade-access-btn').forEach(btn => btn.remove());
      }
      if (!session?.user) document.querySelectorAll('.menu-btn-account').forEach(btn => btn.remove());
    })
    .catch(err => {
      console.error('Premium check failed:', err);
    });
</script>

<!-- ========================================
     DAILY CHALLENGE MENU BUTTON
======================================== -->
<script type="module">
  import { getTodaysDailyChallenge, modeDisplayNames, categoryDisplayNames, categoryEmojis } from './js/daily-challenge.js';
  document.addEventListener('DOMContentLoaded', () => {
    const categorySpan = document.getElementById('dailyChallengeCategory');
    const bg = document.getElementById('dailyChallengeBg');
    const today = getTodaysDailyChallenge();
    if (today && categorySpan && bg) {
      const modeName = modeDisplayNames[today.mode] || today.mode.toUpperCase();
      const categoryName = categoryDisplayNames[today.category] || today.category;
      const emoji = categoryEmojis[today.category] || '';
      categorySpan.textContent = `${modeName}: ${categoryName} ${emoji}`;
      bg.style.backgroundImage = `url('images/categories/${today.category}.jpg')`;
    }
  });
</script>

</body>
</html>