<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeoRanks - Rank by Category</title>

  <!-- Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/home.css" />
  <link rel="stylesheet" href="./css/game-modes.css" />
  
  <style>
    /* Loading overlay to prevent access during auth check */
    #authLoadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(to bottom right, #a7f3d0, #38bdf8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      color: #0d315a;
    }
    
    #authLoadingOverlay h2 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top-color: #0d315a;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<!-- Auth Loading Overlay -->
<div id="authLoadingOverlay">
  <h2>Verifying access...</h2>
  <div class="spinner"></div>
</div>

<header class="home-glass-header">
  <div class="logo-header">
    <a href="index.html" class="logo-link">
      <img src="assets/logo.png" alt="GeoRanks Logo" />
    </a>
  </div>
  <div class="hamburger-menu">
    <div class="menu-icon" id="menuToggle">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
</header>

<div class="menu-overlay" id="menuOverlay">
  <div class="menu-panel">
    <h2>Menu</h2>
    <button class="menu-btn" onclick="window.location.href='index.html'">üè† Home</button>
    <button class="menu-btn menu-btn-account" onclick="window.location.href='account.html'">üë§ Account</button>
    <button class="menu-btn" onclick="window.location.href='leaderboard.html'">üèÜ Leaderboard</button>
    <button class="menu-btn" onclick="window.location.href='stats.html'">üìä My Stats</button>
    <button class="menu-btn">üí° How to Play</button>
    <button class="menu-btn upgrade-access-btn" onclick="window.location.href='premium.html'">üîì Unlock All Categories</button>
    <button class="menu-btn menu-close" id="closeMenu">Close</button>
  </div>
</div>

<!-- üîπ Game Wrapper -->
<div class="blind-ranking-wrapper">
  <div class="top-card">
    <h2 class="top-card-title">Loading category...</h2>
    <div class="country-pool-panel"></div>
  </div>

  <div class="ranking-card">
    <div class="current-flag">
      <div class="flag-box"><span>&lt;Country Flag&gt;</span></div>
    </div>
    <div class="flag-country-name">COUNTRY</div>

    <div class="ranking-list">
      <div class="ranking-row"><div class="rank-number">1</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">2</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">3</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">4</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">5</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">6</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">7</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">8</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">9</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">10</div><div class="rank-slot empty-slot"></div></div>
    </div>
  </div>

  <div class="result-panel" style="display:none;">
    <div class="result-score">Score: <span class="result-score-value">0</span></div>
    <div class="result-breakdown"></div>
    <div class="result-buttons">
      <button class="btn action-play-again">Play Again</button>
      <button class="btn action-play-random">Play Random</button>
      <button class="btn action-share">Share Results</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  import { populationData } from './js/categories/population.js';
  import { gdpData } from './js/categories/gdp.js';
  import { happinessData } from './js/categories/happiness.js';
  import { forestData } from './js/categories/forest.js';
  import { coastlineData } from './js/categories/coastline.js';
  import { cuisineData } from './js/categories/cuisine.js';
  import { olympicData } from './js/categories/olympic.js';
  import { worldcupData } from './js/categories/worldcup.js';
  import { landmassData } from './js/categories/landmass.js';
  import { crimerateData } from './js/categories/crimerate.js';
  import { altitudeData } from './js/categories/altitude.js';
  import { passportData } from './js/categories/passport.js';
  import { beerData } from './js/categories/beer.js';
  import { nobelprizeData } from './js/categories/nobelprize.js';
  import { temperatureData } from './js/categories/temperature.js';
  import { precipitationData } from './js/categories/rainfall.js';

  const supabase = createClient(
    'https://ajwxgdaninuzcpfwawug.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqd3hnZGFuaW51emNwZndhd3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MDI5ODgsImV4cCI6MjA3NzA3ODk4OH0._LvYsqhSZIsWLIvAYtEceg1fXbEuaM0DElY5poVqZxI'
  );

  window.supabase = supabase; // make it globally accessible for blind-ranking.js

  // ========================================
  // üîí PREMIUM VALIDATION GUARD
  // ========================================
  
  // Define which game modes require premium
  const PREMIUM_MODES = [
    'coastline',
    'cuisine',
    'olympic',
    'worldcup',
    'landmass',
    'crimerate',
    'happiness',
    'passport',
    'beer',
    'nobelprize',
    'temperature',
    'precipitation'
  ];

  const params = new URLSearchParams(window.location.search);
  const mode = params.get('mode') || 'population';

  // Check if this mode requires premium
  const requiresPremium = PREMIUM_MODES.includes(mode);

  if (requiresPremium) {
    // Get user session and premium status
    const { data: { session } } = await supabase.auth.getSession();
    
    let isPremium = false;
    
    if (session && session.user) {
      const { data: profile } = await supabase
        .from('users')
        .select('is_premium')
        .eq('id', session.user.id)
        .single();
      
      isPremium = profile?.is_premium === true;
    }
    
    // If user is not premium, redirect to premium page
    if (!isPremium) {
      window.location.href = 'premium.html';
      // Stop execution here
      throw new Error('Premium required');
    }
  }
  
  // Remove loading overlay after validation
  document.getElementById('authLoadingOverlay').style.display = 'none';

  // ========================================
  // üéÆ GAME INITIALIZATION (only if validated)
  // ========================================

  const CATEGORY_ID_MAP = {
    population: 3,
    altitude: 2,
    gdp: 4,
    happiness: 5,
    forest: 6,
    coastline: 7,
    cuisine: 8,
    olympic: 9,
    worldcup: 10,
    landmass: 11,
    crimerate: 12,
    passport: 13,
    beer: 14,
    nobelprize: 15,
    temperature: 16,
    precipitation: 17,
  };

  const datasets = {
    population: { title: 'RANK THESE COUNTRIES BY POPULATION üåç', data: populationData },
    gdp: { title: 'RANK THESE COUNTRIES BY GDP PER CAPITA üí∞', data: gdpData },
    happiness: { title: 'RANK THESE COUNTRIES BY HAPPINESS üòä', data: happinessData },
    forest: { title: 'RANK THESE COUNTRIES BY FOREST COVER üå≤', data: forestData },
    coastline: { title: 'RANK THESE COUNTRIES BY COASTLINE LENGTH üåä', data: coastlineData },
    cuisine: { title: 'RANK THESE COUNTRIES BY CUISINE üçΩÔ∏è', data: cuisineData },
    olympic: { title: 'RANK THESE COUNTRIES BY OLYMPIC MEDALS ü•á', data: olympicData },
    worldcup: { title: 'RANK THESE COUNTRIES BY WORLD CUP TROPHIES ‚öΩ', data: worldcupData },
    landmass: { title: 'RANK THESE COUNTRIES BY LARGEST LAND MASS üóª', data: landmassData },
    crimerate: { title: 'RANK THESE COUNTRIES BY HIGHEST CRIME RATE üö®', data: crimerateData },
    altitude: { title: 'RANK THESE COUNTRIES BY HIGHEST ELEVATION üèîÔ∏è', data: altitudeData },
    passport: { title: 'RANK THESE COUNTRIES BY BEST PASSPORT üõÇ', data: passportData },
    beer: { title: 'RANK THESE COUNTRIES BY HIGHEST BEER CONSUMPTION üç∫', data: beerData },
    nobelprize: { title: 'RANK THESE COUNTRIES BY MOST NOBEL PRIZE WINNERS üïäÔ∏è', data: nobelprizeData },
    temperature: { title: 'RANK THESE COUNTRIES BY HIGHEST AVERAGE TEMPERATURE ‚òÄÔ∏è', data: temperatureData },
    precipitation: { title: 'RANK THESE COUNTRIES BY HIGHEST YEARLY RAINFALL üåßÔ∏è', data: precipitationData },
  };

  const selected = datasets[mode] || datasets.population;

  window.countries = selected.data;
  document.querySelector('.top-card-title').textContent = selected.title;

  const { startBlindRankingGame, setupRankButtons } = await import('./js/blind-ranking.js');

  startBlindRankingGame(CATEGORY_ID_MAP[mode] || 0); // pass category ID into game logic
  setupRankButtons();

  window.scrollTo(0, 0);
  window.datasets = datasets;
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const menuToggle = document.getElementById("menuToggle");
    const menuOverlay = document.getElementById("menuOverlay");
    const closeMenu = document.getElementById("closeMenu");

    if (!menuToggle || !menuOverlay) return;

    menuToggle.addEventListener("click", () => {
      menuOverlay.classList.add("active");
    });

    if (closeMenu) {
      closeMenu.addEventListener("click", () => {
        menuOverlay.classList.remove("active");
      });
    }

    menuOverlay.addEventListener("click", (e) => {
      if (e.target === menuOverlay) {
        menuOverlay.classList.remove("active");
      }
    });
  });
</script>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://ajwxgdaninuzcpfwawug.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqd3hnZGFuaW51emNwZndhd3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MDI5ODgsImV4cCI6MjA3NzA3ODk4OH0._LvYsqhSZIsWLIvAYtEceg1fXbEuaM0DElY5poVqZxI'
  );

  const { data: { session } } = await supabase.auth.getSession();

  if (session && session.user) {
    const { data: profile } = await supabase
      .from('users')
      .select('is_premium')
      .eq('id', session.user.id)
      .single();

    if (profile?.is_premium) {
      document.querySelectorAll('.upgrade-access-btn').forEach(btn => btn.remove());
    }
  }
</script>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  const supabase = createClient('https://ajwxgdaninuzcpfwawug.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqd3hnZGFuaW51emNwZndhd3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MDI5ODgsImV4cCI6MjA3NzA3ODk4OH0._LvYsqhSZIsWLIvAYtEceg1fXbEuaM0DElY5poVqZxI');

  const { data: { session } } = await supabase.auth.getSession();
  const accountBtn = document.querySelector(".menu-btn-account");

  if (!session || !session.user) {
    if (accountBtn) {
      accountBtn.style.display = "none";
    }
  } else {
    if (accountBtn) {
      accountBtn.style.display = "block";
    }
  }
</script>

</body>
</html>