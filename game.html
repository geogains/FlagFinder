<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeoRanks - Rank by Category</title>

  <!-- Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/home.css" />
  <link rel="stylesheet" href="./css/game-modes.css" />
  
  <style>
    /* Loading overlay to prevent access during auth check */
    #authLoadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(to bottom right, #a7f3d0, #38bdf8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      color: #0d315a;
    }
    
    #authLoadingOverlay h2 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top-color: #0d315a;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<!-- Auth Loading Overlay -->
<div id="authLoadingOverlay">
  <h2>Verifying access...</h2>
  <div class="spinner"></div>
</div>

<header class="home-glass-header">
  <div class="logo-header">
    <a href="index.html" class="logo-link">
      <img src="assets/logo.png" alt="GeoRanks Logo" />
    </a>
  </div>
  <div class="hamburger-menu">
    <div class="menu-icon" id="menuToggle">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
</header>

<div class="menu-overlay" id="menuOverlay">
  <div class="menu-panel">
    <h2>Menu</h2>
    <button class="menu-btn" onclick="window.location.href='index.html'">üè† Home</button>
    <button class="menu-btn menu-btn-account" onclick="window.location.href='account.html'">üë§ Account</button>
    <button class="menu-btn" onclick="window.location.href='categories.html'">üéÆ Categories</button>
    <button class="menu-btn" onclick="window.location.href='leaderboard.html'">üèÜ Leaderboard</button>
    <button class="menu-btn" onclick="window.location.href='stats.html'">üìä My Stats</button>
    <button class="menu-btn" onclick="window.location.href='how-to-play.html'">üí° How to Play</button>
    <button class="menu-btn" onclick="location.href='feedback.html'">üí¨ Feedback</button>
    <button class="menu-btn" onclick="location.href='contact.html'">üì© Contact Us</button>
    <button class="menu-btn upgrade-access-btn" onclick="window.location.href='premium.html'">üîì Unlock All Categories</button>
    <button class="menu-btn menu-close" id="closeMenu">Close</button>
  </div>
</div>

<!-- üîπ Game Wrapper -->
<div class="blind-ranking-wrapper">
  <div class="top-card">
    <h2 class="top-card-title">Loading category...</h2>
    <div class="country-pool-panel"></div>
  </div>

  <div class="ranking-card">
    <div class="current-flag">
      <div class="flag-box"><span>&lt;Country Flag&gt;</span></div>
    </div>
    <div class="flag-country-name">COUNTRY</div>

    <div class="ranking-list">
      <div class="ranking-row"><div class="rank-number">1</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">2</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">3</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">4</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">5</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">6</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">7</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">8</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">9</div><div class="rank-slot empty-slot"></div></div>
      <div class="ranking-row"><div class="rank-number">10</div><div class="rank-slot empty-slot"></div></div>
    </div>
  </div>

  <div class="result-panel" style="display:none;">
    <div class="result-score">Score: <span class="result-score-value">0</span></div>
    <div class="result-breakdown"></div>
    <div class="result-buttons">
      <button class="btn action-play-again">Play Again</button>
      <button class="btn action-play-random">Play Random</button>
      <button class="btn action-leaderboard" onclick="window.location.href='leaderboard.html'">üèÜ Leaderboard</button>
      <button class="btn action-share">üì≤ 
        Share Results</button>
    </div>
  </div>
</div>

<script type="module">
  import { populationData } from './js/categories/population.js';
  import { gdpData } from './js/categories/gdp.js';
  import { happinessData } from './js/categories/happiness.js';
  import { forestData } from './js/categories/forest.js';
  import { coastlineData } from './js/categories/coastline.js';
  import { cuisineData } from './js/categories/cuisine.js';
  import { olympicData } from './js/categories/olympic.js';
  import { worldcupData } from './js/categories/worldcup.js';
  import { landmassData } from './js/categories/landmass.js';
  import { crimerateData } from './js/categories/crimerate.js';
  import { altitudeData } from './js/categories/altitude.js';
  import { passportData } from './js/categories/passport.js';
  import { beerData } from './js/categories/beer.js';
  import { nobelprizeData } from './js/categories/nobelprize.js';
  import { temperatureData } from './js/categories/temperature.js';
  import { precipitationData } from './js/categories/rainfall.js';
  import { tourismData } from './js/categories/tourism.js';
  import { michelinData } from './js/categories/michelin.js';
  import { bigmacData } from './js/categories/bigmac.js';
  import { lifeexpectancyData } from './js/categories/lifeexpectancy.js';
  // NEW CATEGORIES
  import { marriageageData } from './js/categories/marriageage.js';
  import { sexratioData } from './js/categories/sexratio.js';
  import { tallestbuildingData } from './js/categories/tallestbuilding.js';
  import { densityData } from './js/categories/density.js';
  import { carexportsData } from './js/categories/carexports.js';
  import { militaryPersonnelData } from './js/categories/militarypersonel.js';
  import { rentData } from './js/categories/rent.js';
  import { poorestgdpData } from './js/categories/poorestgdp.js';
  import { universityData } from './js/categories/university.js';
  import { volcanoData } from './js/categories/volcano.js';
  import { flamingoData } from './js/categories/flamingo.js';
  import { disasterRiskData } from './js/categories/disasterrisk.js';
  import { longestriverData } from './js/categories/longestriver.js';
  import { renewableShareData } from './js/categories/renewableenergy.js';
  import { millionaireData } from './js/categories/millionaires.js';
  import { chessGMData } from './js/categories/gm.js';

  window.datasets = {
    population: { title: 'RANK COUNTRIES FROM LARGEST TO SMALLEST POPULATION üë•', data: populationData },
    gdp: { title: 'RANK COUNTRIES BASED ON AVERAGE INCOME PER PERSON üí∞', data: gdpData },
    happiness: { title: 'RANK THESE COUNTRIES BY NATIONAL HAPPINESS SCORES üòä', data: happinessData },
    forest: { title: 'RANK COUNTRIES BASED ON THE TOTAL AREA COVERED BY FORESTS üå≤', data: forestData },
    coastline: { title: 'RANK THESE COUNTRIES BY TOTAL COASTLINE LENGTH üèùÔ∏è', data: coastlineData },
    cuisine: { title: 'RANK THESE COUNTRIES BY CUISINE POPULARITY AND QUALITY üçΩÔ∏è', data: cuisineData },
    olympic: { title: 'RANK COUNTRIES BY TOTAL OLYMPIC MEDALS WON ü•á', data: olympicData },
    worldcup: { title: 'RANK COUNTRIES BY THE NUMBER OF FIFA WORLD CUP TITLES THEY‚ÄôVE WON ‚öΩ', data: worldcupData },
    landmass: { title: 'RANK COUNTRIES FROM LARGEST TO SMALLEST TOTAL LAND AREA üåç', data: landmassData },
    crimerate: { title: 'RANK THESE COUNTRIES BY HIGHEST CRIME RATE üö®', data: crimerateData },
    altitude: { title: 'RANK THESE COUNTRIES BY HIGHEST ELEVATION üèîÔ∏è', data: altitudeData },
    passport: { title: 'RANK THESE COUNTRIES BY BEST PASSPORT üõÇ', data: passportData },
    beer: { title: 'RANK THESE COUNTRIES BY ANUAL BEER CONSUMPTION PER CAPITA üç∫', data: beerData },
    nobelprize: { title: 'RANK THESE COUNTRIES BY MOST NOBEL PRIZE WINNERS üïäÔ∏è', data: nobelprizeData },
    temperature: { title: 'RANK THESE COUNTRIES BY HIGHEST AVERAGE TEMPERATURE ‚òÄÔ∏è', data: temperatureData },
    hightemp: { title: 'RANK THESE COUNTRIES BY HIGHEST AVERAGE TEMPERATURE ‚òÄÔ∏è', data: temperatureData },
    precipitation: { title: 'RANK THESE COUNTRIES BY HIGHEST AVERAGE PERCIPITATION üåßÔ∏è', data: precipitationData },
    rainfall: { title: 'RANK THESE COUNTRIES BY HIGHEST AVERAGE PERCIPITATION üåßÔ∏è', data: precipitationData },
    tourism: { title: 'RANK COUNTRIES BY NUMBER OF TOURIST VISITS ‚úàÔ∏è', data: tourismData },
    michelin: { title: 'RANK COUNTRIES BY MICHELIN STARRED RESTAURANTS ‚≠ê', data: michelinData },
    bigmac: { title: 'RANK COUNTRIES BY BIG MAC PRICE üçî', data: bigmacData },
    lifeexpectancy: { title: 'RANK COUNTRIES BY LIFE EXPECTANCY üè•', data: lifeexpectancyData },
    // NEW CATEGORIES
    marriageage: { title: 'RANK COUNTRIES BY AVERAGE MARRIAGE AGE üíç', data: marriageageData },
    sexratio: { title: 'RANK COUNTRIES BY SEX RATIO ‚öñÔ∏è', data: sexratioData },
    tallestbuilding: { title: 'RANK COUNTRIES BY TALLEST BUILDING üèôÔ∏è', data: tallestbuildingData },
    density: { title: 'RANK COUNTRIES BY POPULATION DENSITY üë®‚Äçüë©‚Äçüëß‚Äçüë¶', data: densityData },
    carexports: { title: 'RANK COUNTRIES BY CAR EXPORTS üöó', data: carexportsData },
    militarypersonel: { title: 'RANK COUNTRIES BY MILITARY PERSONNEL ü™ñ', data: militaryPersonnelData },
    rent: { title: 'RANK COUNTRIES BY AVERAGE RENT PRICES üè†', data: rentData },
    poorestgdp: { title: 'RANK COUNTRIES BY LOWEST GDP PER CAPITA üìâ', data: poorestgdpData },
    university: { title: 'RANK COUNTRIES BY TOP UNIVERSITIES üéì', data: universityData },
    volcano: { title: 'RANK COUNTRIES BY NUMBER OF VOLCANOES üåã', data: volcanoData },
    flamingo: { title: 'RANK COUNTRIES BY FLAMINGO POPULATION ü¶©', data: flamingoData },
    disasterrisk: { title: 'RANK COUNTRIES BY DISASTER RISK ‚ö†Ô∏è', data: disasterRiskData },
    longestriver: { title: 'RANK COUNTRIES BY LONGEST RIVER üåä', data: longestriverData },
    renewableenergy: { title: 'RANK COUNTRIES BY RENEWABLE ENERGY USE ‚ôªÔ∏è', data: renewableShareData },
    millionaires: { title: 'RANK COUNTRIES BY NUMBER OF MILLIONAIRES üí∞', data: millionaireData },
    gm: { title: 'RANK COUNTRIES BY CHESS GRANDMASTERS ‚ôüÔ∏è', data: chessGMData },
  };
</script>

<script type="module">
  import { supabase } from './js/supabase-client.js';
  import { isValidDailyChallenge } from './js/daily-challenge.js';
  
  // ========================================
  // üîí PREMIUM VALIDATION GUARD
  // ========================================
  
  // Define which game modes require premium
  const PREMIUM_MODES = [
    'coastline',
    'cuisine',
    'olympic',
    'worldcup',
    'landmass',
    'crimerate',
    'happiness',
    'passport',
    'beer',
    'nobelprize',
    'temperature',
    'precipitation',
    'tourism',
    'michelin',
    'bigmac',
    'lifeexpectancy',
    // NEW CATEGORIES
    'marriageage',
    'sexratio',
    'tallestbuilding',
    'density',
    'carexports',
    'militarypersonel',
    'rent',
    'poorestgdp',
    'university',
    'volcano',
    'flamingo',
    'disasterrisk',
    'longestriver',
    'renewableenergy',
    'millionaires',
    'gm',
  ];

  const params = new URLSearchParams(window.location.search);
  const mode = params.get('mode') || 'population';
  const isDailyParam = params.get('daily') === 'true';

  // SECURITY FIX: Validate that this is actually today's daily challenge
  // This prevents users from manually adding ?daily=true to bypass premium
  const isValidDaily = isDailyParam && isValidDailyChallenge('classic', mode);
  
  if (isDailyParam && !isValidDaily) {
    console.warn('‚ö†Ô∏è Invalid daily challenge attempt detected - mode/category mismatch');
  }

  // Check if this mode requires premium (only bypass if VALID daily challenge)
  const requiresPremium = PREMIUM_MODES.includes(mode) && !isValidDaily;

  if (requiresPremium) {
    // Get user session and premium status
    const { data: { session } } = await supabase.auth.getSession();
    
    let isPremium = false;
    
    if (session && session.user) {
      const { data: profile } = await supabase
        .from('users')
        .select('is_premium')
        .eq('id', session.user.id)
        .single();
      
      isPremium = profile?.is_premium === true;
    }
    
    // If user is not premium, redirect to premium page
    if (!isPremium) {
      window.location.href = 'premium.html';
      // Stop execution here
      throw new Error('Premium required');
    }
  }
  
  // Remove loading overlay after validation
  document.getElementById('authLoadingOverlay').style.display = 'none';

  // ========================================
  // üéÆ GAME INITIALIZATION (only if validated)
  // ========================================

  import { CATEGORY_ID_MAP } from './js/top10-categories-loader.js';

  const selected = datasets[mode] || datasets.population;

  window.countries = selected.data;
  document.querySelector('.top-card-title').textContent = selected.title;

  const { startBlindRankingGame, setupRankButtons } = await import('./js/blind-ranking.js');

  startBlindRankingGame(CATEGORY_ID_MAP[mode] || 0); // pass category ID into game logic
  setupRankButtons();

  window.scrollTo(0, 0);
  window.datasets = datasets;
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const menuToggle = document.getElementById("menuToggle");
    const menuOverlay = document.getElementById("menuOverlay");
    const closeMenu = document.getElementById("closeMenu");

    if (!menuToggle || !menuOverlay) return;

    menuToggle.addEventListener("click", () => {
      menuOverlay.classList.add("active");
    });

    if (closeMenu) {
      closeMenu.addEventListener("click", () => {
        menuOverlay.classList.remove("active");
      });
    }

    menuOverlay.addEventListener("click", (e) => {
      if (e.target === menuOverlay) {
        menuOverlay.classList.remove("active");
      }
    });
  });
</script>

<script type="module">
  import { supabase } from './js/supabase-client.js';

  const { data: { session } } = await supabase.auth.getSession();

  // Hide Account if user not logged in
  if (!session || !session.user) {
    document.querySelectorAll('.menu-btn-account').forEach(btn => btn.remove());
  }

  // Hide Unlock All Categories if user is premium
  if (session && session.user) {
    const { data: profile } = await supabase
      .from('users')
      .select('is_premium')
      .eq('id', session.user.id)
      .single();

    if (profile?.is_premium) {
      document.querySelectorAll('.upgrade-access-btn').forEach(btn => btn.remove());
    }
  }
</script>

</body>
</html>