<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeoRanks ‚Äî Account</title>
  <link rel="stylesheet" href="css/home.css" />
  <link rel="stylesheet" href="css/game-modes.css" />

  <style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(40px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in {
    animation: fadeInUp 0.8s ease-out both;
  }

     html, body {
  height: 100%;
  margin: 0;
}

body {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

.account-glass-card {
  width: 90%;
  max-width: 480px;
  margin: 100px auto 60px;
  background: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border-radius: 16px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
  padding: 2rem;
  text-align: center;
  box-sizing: border-box; /* Ensure padding doesn't break width */
}


  .account-glass-card h2 {
    margin-top: 0;
    margin-bottom: 1rem;
  }

  .account-info p {
    margin: 0.5rem 0;
  }

  .form-section {
    margin-top: 1.8rem;
    text-align: left;
  }

  .form-section input {
    width: 100%;
    margin-top: 0.6rem;
    padding: 0.65rem 1rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }

  .full-btn {
    display: block;
    width: 100%;
    margin-top: 1rem;
    padding: 0.8rem 1rem;
  }

  .logout-btn {
    background: linear-gradient(90deg, #222222, #171717);
    margin-top: 2rem;
  }

  .message {
    margin-top: 0.75rem;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .message {
  margin-top: 0.75rem;
  font-size: 0.9rem;
  font-weight: 500;
  transition: color 0.3s ease;
}
</style>

</head>


<body>

<!-- ‚úÖ Glass Header with Logo and Hamburger -->
<header class="home-glass-header">
  <div class="logo-header">
    <a href="index.html" class="logo-link">
      <img src="assets/logo.png" alt="GeoRanks Logo" />
    </a>
  </div>
  <div class="hamburger-menu">
    <div class="menu-icon" id="menuToggle">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
</header>

<!-- ‚úÖ Sliding Menu Overlay -->
<div class="menu-overlay" id="menuOverlay">
  <div class="menu-panel">
    <h2>Menu</h2>
    <button class="menu-btn menu-daily-challenge" onclick="window.location.href='daily-challenge.html'" id="dailyChallengeMenuBtn">
  <div class="daily-bg" id="dailyChallengeBg"></div>
  <div class="daily-overlay"></div>
  <div class="daily-content">
    <h3 class="daily-title">üìÖ Daily Challenge</h3>
    <span class="daily-category" id="dailyChallengeCategory">Loading...</span>
  </div>
</button>
    <button class="menu-btn" onclick="window.location.href='index.html'">üè† Home</button>
    <button class="menu-btn" onclick="window.location.href='leaderboard.html'">üèÜ Leaderboard</button>
    <button class="menu-btn" onclick="window.location.href='stats.html'">üìä My Stats</button>
    <button class="menu-btn" onclick="window.location.href='how-to-play.html'">üí° How to Play</button>
    <button class="menu-btn" onclick="location.href='feedback.html'">üí¨ Feedback</button>
    <button class="menu-btn" onclick="location.href='contact.html'">üì© Contact Us</button>
    <button class="menu-btn upgrade-access-btn" onclick="window.location.href='premium.html'">üîì Unlock All Categories</button>
    <button class="menu-btn menu-close" id="closeMenu">Close</button>
  </div>
</div>

<!-- ‚úÖ Page Content Wrapper -->
<main class="account-glass-card fade-in">
    <h2>Account Settings</h2>

    <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 1rem;">
  <div style="position: relative; display: inline-block; margin-bottom: 0.8rem;">
    <img id="profilePreview" src="assets/profile-icon.jpg" alt="Profile Icon"
      style="width: 110px; height: 110px; object-fit: cover; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.2);" />
    <img id="premiumBadge" src="assets/GeoRanksPremium.png" alt="Premium Badge"
      style="position: absolute; bottom: -2px; right: -2px; width: 36px; height: 36px; display: none;" />
  </div>

  <button class="btn full-btn" id="uploadAvatarBtn">Upload Photo</button>
  <button class="btn full-btn" id="deleteAvatarBtn">Remove Photo</button>
  <input type="file" id="avatarUpload" accept="image/*" style="display: none;" />
  <div class="message" id="avatarMsg"></div>
</div>


    <div class="account-info">
      <p><strong>Username:</strong> <span id="currentUsername">Loading...</span></p>
      <p><strong>Email:</strong> <span id="userEmail">Loading...</span></p>
      <p><strong>Member Since:</strong> <span id="userSince">‚Äî</span></p>
    </div>

    <!-- ‚úÖ Section to Change Username -->
    <div class="form-section">
      <h3>üë§ Change Username</h3>
      <input type="text" id="newUsername" placeholder="Enter new username" />
      <button class="btn full-btn" id="changeUsernameBtn">Update Username</button>
      <div class="message" id="usernameMsg"></div>
    </div>

    <!-- ‚úÖ Section to Change Email -->
    <div class="form-section">
      <h3>‚úâÔ∏è Change Email Address</h3>
      <input type="email" id="newEmail" placeholder="Enter new email" />
      <button class="btn full-btn" id="changeEmailBtn">Update Email</button>
      <div class="message" id="emailMsg"></div>
    </div>

   <button class="upgrade-btn upgrade-access-btn" onclick="window.location.href='premium.html'">
  Unlock All Categories
</button>


    <button class="btn full-btn logout-btn" id="logoutBtn">Log Out</button>
  </div>
</main>

  <footer class="home-footer">
  <div class="footer-socials">
    <div class="icon-row">
      <a href="https://www.instagram.com/geo_ranks/" target="_blank" rel="noopener">
        <img src="assets/instagram.png" alt="Instagram" />
      </a>
      <div class="divider"></div>
      <a href="https://www.tiktok.com/@georanks" target="_blank" rel="noopener">
        <img src="assets/tik-tok.png" alt="TikTok" />
      </a>
      <div class="divider"></div>
      <a href="https://www.youtube.com/channel/UC8jrsBpCn09u0mHQle_O3Rw" target="_blank" rel="noopener">
        <img src="assets/youtube.png" alt="YouTube" />
      </a>
    <div class="divider"></div>
      <a href="https://x.com/Kieroncroo66687" target="_blank" rel="noopener">
        <img src="assets/x.png" alt="X" />
      </a>
    </div>
    <p>¬© 2025 GeoRanks</p>
  </div>
</footer>

<!-- ‚úÖ Supabase Script -->
<script type="module">
  import { supabase } from './js/supabase-client.js';

  (async () => {
    const usernameSpan = document.getElementById('currentUsername');
    const emailSpan = document.getElementById('userEmail');
    const sinceSpan = document.getElementById('userSince');
    const newUsernameInput = document.getElementById('newUsername');
    const changeUsernameBtn = document.getElementById('changeUsernameBtn');
    const usernameMsg = document.getElementById('usernameMsg');
    const newEmailInput = document.getElementById('newEmail');
    const changeEmailBtn = document.getElementById('changeEmailBtn');
    const emailMsg = document.getElementById('emailMsg');
    const logoutBtn = document.getElementById('logoutBtn');

    const { data: { session } } = await supabase.auth.getSession();

    if (!session?.user) {
      window.location.href = 'index.html';
      return;
    }

    const currentUser = session.user;
    emailSpan.textContent = currentUser.email;
    sinceSpan.textContent = new Date(currentUser.created_at).toLocaleDateString();

    const { data: profile, error } = await supabase
      .from('users')
      .select('username, is_premium, avatar_url')
      .eq('id', currentUser.id)
      .single();

    if (profile) {
      usernameSpan.textContent = profile.username || 'Not set';

      const premiumBadge = document.getElementById('premiumBadge');

      if (profile.is_premium) {
        document.querySelectorAll('.upgrade-access-btn').forEach(btn => btn.remove());
        if (premiumBadge) premiumBadge.style.display = 'block';
      } else {
        if (premiumBadge) premiumBadge.style.display = 'none';
      }

      // Avatar logic
      const avatarUpload = document.getElementById('avatarUpload');
      const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
      const deleteAvatarBtn = document.getElementById('deleteAvatarBtn');
      const avatarMsg = document.getElementById('avatarMsg');
      const profilePreview = document.getElementById('profilePreview');

      // Load existing avatar with cache buster
      if (profile.avatar_url) {
        profilePreview.src = `${profile.avatar_url}?t=${Date.now()}`;
      }

      uploadAvatarBtn?.addEventListener('click', () => {
        avatarUpload.click();
      });

      // ‚ú® IMAGE COMPRESSION FUNCTION
      async function compressImage(file, maxWidth = 400, maxHeight = 400, quality = 0.85) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;

              // Calculate new dimensions while maintaining aspect ratio
              if (width > height) {
                if (width > maxWidth) {
                  height *= maxWidth / width;
                  width = maxWidth;
                }
              } else {
                if (height > maxHeight) {
                  width *= maxHeight / height;
                  height = maxHeight;
                }
              }

              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              canvas.toBlob((blob) => {
                if (blob) {
                  resolve(new File([blob], file.name, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                  }));
                } else {
                  reject(new Error('Compression failed'));
                }
              }, 'image/jpeg', quality);
            };
            img.onerror = () => reject(new Error('Failed to load image'));
            img.src = e.target.result;
          };
          reader.onerror = () => reject(new Error('Failed to read file'));
          reader.readAsDataURL(file);
        });
      }

      avatarUpload?.addEventListener('change', async () => {
        const file = avatarUpload.files[0];
        if (!file || !currentUser) return;

        // ‚úÖ VALIDATE FILE SIZE (5MB max before compression)
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
          avatarMsg.textContent = '‚ùå File too large. Max 5MB.';
          avatarMsg.style.color = '#ef4444';
          avatarUpload.value = ''; // Clear input
          return;
        }

        // ‚úÖ VALIDATE FILE TYPE
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
        if (!validTypes.includes(file.type)) {
          avatarMsg.textContent = '‚ùå Invalid file type. Use JPG, PNG, or WebP.';
          avatarMsg.style.color = '#ef4444';
          avatarUpload.value = '';
          return;
        }

        // Show loading state
        avatarMsg.textContent = '‚è≥ Processing...';
        avatarMsg.style.color = '#6366f1';
        uploadAvatarBtn.disabled = true;

        try {
          // ‚úÖ COMPRESS IMAGE
          console.log('Original file size:', (file.size / 1024).toFixed(2), 'KB');
          const compressedFile = await compressImage(file, 400, 400, 0.85);
          console.log('Compressed file size:', (compressedFile.size / 1024).toFixed(2), 'KB');
          console.log('Compression ratio:', ((1 - compressedFile.size / file.size) * 100).toFixed(1) + '%');

          // Always save as .jpg after compression
          const filePath = `${currentUser.id}.jpg`;

          // Show uploading state
          avatarMsg.textContent = '‚è≥ Uploading...';

          const { error: uploadError } = await supabase.storage
            .from('avatars')
            .upload(filePath, compressedFile, {
              upsert: true,
              contentType: 'image/jpeg',
              cacheControl: '3600' // Cache for 1 hour
            });

          if (uploadError) {
            console.error('Upload error:', uploadError);
            avatarMsg.textContent = '‚ùå Upload failed';
            avatarMsg.style.color = '#ef4444';
            uploadAvatarBtn.disabled = false;
            return;
          }

          const { data } = supabase.storage
            .from('avatars')
            .getPublicUrl(filePath);

          // Store clean URL in database (without cache buster)
          const publicUrl = data.publicUrl;

          const { error: updateError } = await supabase
            .from('users')
            .update({ avatar_url: publicUrl })
            .eq('id', currentUser.id);

          if (!updateError) {
            // Display with cache buster for immediate update
            profilePreview.src = `${publicUrl}?t=${Date.now()}`;
            avatarMsg.textContent = '‚úÖ Avatar updated!';
            avatarMsg.style.color = '#22c55e';
          } else {
            console.error('Database update error:', updateError);
            avatarMsg.textContent = '‚ùå Failed to update profile';
            avatarMsg.style.color = '#ef4444';
          }
        } catch (error) {
          console.error('Processing error:', error);
          avatarMsg.textContent = '‚ùå Failed to process image';
          avatarMsg.style.color = '#ef4444';
        } finally {
          uploadAvatarBtn.disabled = false;
        }
      });

      deleteAvatarBtn?.addEventListener('click', async () => {
        if (!currentUser) return;

        avatarMsg.textContent = '‚è≥ Removing...';
        avatarMsg.style.color = '#6366f1';
        deleteAvatarBtn.disabled = true;

        try {
          // Remove all possible extensions
          await supabase.storage
            .from('avatars')
            .remove([`${currentUser.id}.jpg`, `${currentUser.id}.png`, `${currentUser.id}.jpeg`]);

          const { error } = await supabase
            .from('users')
            .update({ avatar_url: null })
            .eq('id', currentUser.id);

          if (!error) {
            profilePreview.src = `assets/profile-icon.jpg?t=${Date.now()}`;
            avatarMsg.textContent = '‚úÖ Reverted to default avatar';
            avatarMsg.style.color = '#22c55e';
          } else {
            console.error('Delete error:', error);
            avatarMsg.textContent = '‚ùå Failed to delete avatar';
            avatarMsg.style.color = '#ef4444';
          }
        } finally {
          deleteAvatarBtn.disabled = false;
        }
      });
    }

    changeUsernameBtn?.addEventListener('click', async () => {
      const newUsername = newUsernameInput.value.trim();
      if (!newUsername) return;

      const { error } = await supabase
        .from('users')
        .update({ username: newUsername })
        .eq('id', currentUser.id);

      usernameMsg.textContent = error ? error.message : '‚úÖ Username updated';
    });

    changeEmailBtn?.addEventListener('click', async () => {
      const newEmail = newEmailInput.value.trim();
      if (!newEmail) return;

      const { error } = await supabase.auth.updateUser({ email: newEmail });
      emailMsg.textContent = error ? error.message : '‚úÖ Confirmation email sent';
    });

    logoutBtn?.addEventListener('click', async () => {
      try {
        console.log('Logging out...');
        
        // Sign out from Supabase
        const { error } = await supabase.auth.signOut();
        if (error) console.error('Supabase signOut error:', error);
        
        // Clear all storage
        localStorage.clear();
        sessionStorage.clear();
        
        // Clear cookies (if any)
        document.cookie.split(";").forEach((c) => {
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
        });
        
        console.log('Logout complete, redirecting...');
        
        // Force redirect with cache busting
        window.location.href = 'index.html?logout=' + Date.now();
      } catch (error) {
        console.error('Logout error:', error);
        // Force redirect anyway
        window.location.href = 'index.html?logout=' + Date.now();
      }
    });

  })();
</script>

<script>
  // Menu toggle logic
  document.addEventListener("DOMContentLoaded", () => {
    const menuToggle = document.getElementById("menuToggle");
    const menuOverlay = document.getElementById("menuOverlay");
    const closeMenu = document.getElementById("closeMenu");

    menuToggle?.addEventListener("click", () => {
      menuOverlay.classList.add("active");
    });

    closeMenu?.addEventListener("click", () => {
      menuOverlay.classList.remove("active");
    });

    menuOverlay?.addEventListener("click", (e) => {
      if (e.target === menuOverlay) {
        menuOverlay.classList.remove("active");
      }
    });
  });
</script>

<script type="module">
  import {
    getTodaysDailyChallenge,
    modeDisplayNames,
    categoryDisplayNames,
    categoryEmojis
  } from './js/daily-challenge.js';

  document.addEventListener('DOMContentLoaded', () => {
    const categorySpan = document.getElementById('dailyChallengeCategory');
    const bg = document.getElementById('dailyChallengeBg');

    const today = getTodaysDailyChallenge();

    if (today && categorySpan && bg) {
      const modeName = modeDisplayNames[today.mode] || today.mode.toUpperCase();
      const categoryName = categoryDisplayNames[today.category] || today.category;
      const emoji = categoryEmojis[today.category] || '';

      categorySpan.textContent = `${modeName}: ${categoryName} ${emoji}`;
      bg.style.backgroundImage = `url('images/categories/${today.category}.jpg')`;
    }
  });
</script>

<!-- Load Stripe FIRST -->
<script src="https://js.stripe.com/v3/"></script>
</body>
</html>