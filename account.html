<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Account Settings | GeoRanks</title>
  <link rel="icon" href="assets/favicon.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Shared Page Styles -->
  <link rel="stylesheet" href="css/page.css">
  
  <style>
    /* ========================================
       ACCOUNT PAGE CONTENT
    ======================================== */
    .account-container {
      max-width: 580px;
      margin: 120px auto 60px;
      padding: 48px 40px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-radius: 24px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      opacity: 0;
      animation: fadeInContainer 0.5s ease-out forwards;
    }
    
    @keyframes fadeInContainer {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .page-title {
      font-size: 2.4rem;
      font-weight: 700;
      color: #0d315a;
      text-align: center;
      margin-bottom: 40px;
      opacity: 0;
      animation: fadeIn 0.5s ease-out 0.2s forwards;
    }
    
    .page-title-text {
      background: linear-gradient(135deg, #0d315a 0%, #0d315a 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* Profile Section */
    .profile-section {
      text-align: center;
      margin-bottom: 40px;
      opacity: 0;
      animation: fadeIn 0.5s ease-out 0.4s forwards;
    }
    
    .avatar-container {
      position: relative;
      display: inline-block;
      margin-bottom: 20px;
    }
    
    .avatar-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid rgba(102, 126, 234, 0.2);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
    }
    
    .avatar-preview:hover {
      transform: scale(1.05);
      border-color: rgba(102, 126, 234, 0.4);
    }
    
    .premium-badge {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 38px;
      height: 38px;
      display: none;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }
    
    .avatar-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }
    
    /* Account Info Cards */
    .info-card {
      background: rgba(255, 255, 255, 0.6);
      border: 2px solid rgba(102, 126, 234, 0.1);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 16px;
      opacity: 0;
      animation: fadeIn 0.5s ease-out 0.6s forwards;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(102, 126, 234, 0.08);
    }
    
    .info-row:last-child {
      border-bottom: none;
    }
    
    .info-label {
      font-weight: 600;
      color: #4b5563;
      font-size: 0.95rem;
    }
    
    .info-value {
      font-weight: 600;
      color: #0d315a;
      font-size: 1rem;
    }
    
    /* Form Sections */
    .form-section {
      background: rgba(255, 255, 255, 0.6);
      border: 2px solid rgba(102, 126, 234, 0.1);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      opacity: 0;
      animation: fadeIn 0.5s ease-out 0.8s forwards;
    }
    
    .form-section h3 {
      font-size: 1.2rem;
      font-weight: 700;
      color: #0d315a;
      margin-bottom: 16px;
    }
    
    .form-input {
      width: 100%;
      padding: 14px 18px;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      border: 2px solid rgba(102, 126, 234, 0.15);
      border-radius: 12px;
      background: white;
      transition: all 0.3s ease;
      margin-bottom: 12px;
    }
    
    .form-input:focus {
      outline: none;
      border-color: rgba(102, 126, 234, 0.4);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: rgba(102, 126, 234, 0.08);
      color: #0d315a;
      border: 2px solid rgba(102, 126, 234, 0.15);
    }
    
    .btn-secondary:hover {
      background: rgba(102, 126, 234, 0.12);
      border-color: rgba(102, 126, 234, 0.25);
    }
    
    .btn-small {
      padding: 10px 20px;
      font-size: 0.9rem;
      width: auto;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
      margin-top: 32px;
      opacity: 0;
      animation: fadeIn 0.5s ease-out 1.2s forwards;
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }
    
    .upgrade-btn {
      background: linear-gradient(135deg, #ff9770 0%, #ff6f61 100%);
      color: white;
      box-shadow: 0 4px 16px rgba(255, 151, 112, 0.3);
      margin-top: 24px;
      opacity: 0;
      animation: fadeIn 0.5s ease-out 1s forwards;
    }
    
    .upgrade-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 151, 112, 0.4);
    }
    
    /* Messages */
    .message {
      margin-top: 12px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .message:empty {
      display: none;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .account-container {
        margin: 90px 16px 40px;
        padding: 32px 24px;
      }
      
      .page-title {
        font-size: 2rem;
      }
      
      .avatar-preview {
        width: 100px;
        height: 100px;
      }
      
      .avatar-buttons {
        flex-direction: column;
      }
      
      .btn-small {
        width: 100%;
      }
      
      .info-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
    }
  </style>
</head>
<body>

<!-- ========== HEADER ========== -->
<header class="home-glass-header">
  <div class="logo-header">
    <a href="index.html" class="logo-link">
      <img src="assets/logo.png" alt="GeoRanks Logo" />
    </a>
  </div>
  <div class="menu-icon" id="menuToggle">
    <span></span>
    <span></span>
    <span></span>
  </div>
</header>

<!-- ========== HAMBURGER MENU ========== -->
<div class="menu-overlay" id="menuOverlay">
  <div class="menu-panel">
    <h2>Menu</h2>
    
    <button class="menu-btn menu-daily-challenge" onclick="window.location.href='daily-challenge.html'" id="dailyChallengeMenuBtn">
      <div class="daily-bg" id="dailyChallengeBg"></div>
      <div class="daily-overlay"></div>
      <div class="daily-content">
        <h3 class="daily-title">üìÖ Daily Challenge</h3>
        <span class="daily-category" id="dailyChallengeCategory">Loading...</span>
      </div>
    </button>
    
    <button class="menu-btn" onclick="window.location.href='index.html'">üè† Home</button>
    <button class="menu-btn" onclick="window.location.href='leaderboard.html'">üèÜ Leaderboard</button>
    <button class="menu-btn" onclick="window.location.href='stats.html'">üìä My Stats</button>
    <button class="menu-btn" onclick="window.location.href='how-to-play.html'">üí° How to Play</button>
    <button class="menu-btn" onclick="location.href='feedback.html'">üí¨ Feedback</button>
    <button class="menu-btn" onclick="location.href='contact.html'">üì© Contact Us</button>
    <button class="menu-btn upgrade-access-btn" onclick="window.location.href='premium.html'">üîì Unlock All Categories</button>
    <button class="menu-btn menu-close" id="closeMenu">Close</button>
  </div>
</div>

<!-- ========== ACCOUNT CONTENT ========== -->
<div class="account-container">
  <h1 class="page-title">üë§ <span class="page-title-text">Account Settings</span></h1>

  <!-- Profile Section -->
  <div class="profile-section">
    <div class="avatar-container">
      <img id="profilePreview" src="assets/profile-icon.jpg" alt="Profile" class="avatar-preview" />
      <img id="premiumBadge" src="assets/GeoRanksPremium.png" alt="Premium" class="premium-badge" />
    </div>
    
    <div class="avatar-buttons">
      <button class="btn btn-secondary btn-small" id="uploadAvatarBtn">üì∏ Upload Photo</button>
      <button class="btn btn-secondary btn-small" id="deleteAvatarBtn">üóëÔ∏è Remove Photo</button>
    </div>
    <input type="file" id="avatarUpload" accept="image/*" style="display: none;" />
    <div class="message" id="avatarMsg"></div>
  </div>

  <!-- Account Info -->
  <div class="info-card">
    <div class="info-row">
      <span class="info-label">üë§ Username</span>
      <span class="info-value" id="currentUsername">Loading...</span>
    </div>
    <div class="info-row">
      <span class="info-label">‚úâÔ∏è Email</span>
      <span class="info-value" id="userEmail">Loading...</span>
    </div>
    <div class="info-row">
      <span class="info-label">üìÖ Member Since</span>
      <span class="info-value" id="userSince">‚Äî</span>
    </div>
  </div>

  <!-- Change Username -->
  <div class="form-section">
    <h3>üë§ Change Username</h3>
    <input type="text" id="newUsername" placeholder="Enter new username" class="form-input" />
    <button class="btn btn-primary" id="changeUsernameBtn">Update Username</button>
    <div class="message" id="usernameMsg"></div>
  </div>

  <!-- Change Email -->
  <div class="form-section">
    <h3>‚úâÔ∏è Change Email Address</h3>
    <input type="email" id="newEmail" placeholder="Enter new email" class="form-input" />
    <button class="btn btn-primary" id="changeEmailBtn">Update Email</button>
    <div class="message" id="emailMsg"></div>
  </div>

  <!-- Upgrade Button -->
  <button class="btn upgrade-btn" onclick="window.location.href='premium.html'">
    üîì Unlock All Categories
  </button>

  <!-- Logout Button -->
  <button class="btn btn-danger" id="logoutBtn">Log Out</button>
</div>

<!-- ========== JAVASCRIPT ========== -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const menuToggle = document.getElementById('menuToggle');
  const menuOverlay = document.getElementById('menuOverlay');
  const closeMenu = document.getElementById('closeMenu');
  let scrollPosition = 0;

  if (menuToggle && menuOverlay) {
    menuToggle.addEventListener('click', () => {
      scrollPosition = window.pageYOffset;
      document.body.classList.add('menu-open');
      document.body.style.top = `-${scrollPosition}px`;
      menuOverlay.classList.add('active');
    });

    function closeMenuHandler() {
      document.body.classList.remove('menu-open');
      document.body.style.top = '';
      window.scrollTo(0, scrollPosition);
      menuOverlay.classList.remove('active');
    }

    closeMenu?.addEventListener('click', closeMenuHandler);

    menuOverlay.addEventListener('click', (e) => {
      if (e.target === menuOverlay) {
        closeMenuHandler();
      }
    });
  }
});
</script>

<!-- Daily Challenge Menu Button -->
<script type="module">
  import { getTodaysDailyChallenge, modeDisplayNames, categoryDisplayNames, categoryEmojis } from './js/daily-challenge.js';
  document.addEventListener('DOMContentLoaded', () => {
    const categorySpan = document.getElementById('dailyChallengeCategory');
    const bg = document.getElementById('dailyChallengeBg');
    const today = getTodaysDailyChallenge();
    if (today && categorySpan && bg) {
      const modeName = modeDisplayNames[today.mode] || today.mode.toUpperCase();
      const categoryName = categoryDisplayNames[today.category] || today.category;
      const emoji = categoryEmojis[today.category] || '';
      categorySpan.textContent = `${modeName}: ${categoryName} ${emoji}`;
      bg.style.backgroundImage = `url('images/categories/${today.category}.jpg')`;
    }
  });
</script>

<!-- Account Functionality -->
<script type="module">
  import { supabase } from './js/supabase-client.js';

  (async () => {
    const { data: { session } } = await supabase.auth.getSession();

    if (!session || !session.user) {
      window.location.href = 'auth.html';
      return;
    }

    const currentUser = session.user;
    const usernameSpan = document.getElementById('currentUsername');
    const emailSpan = document.getElementById('userEmail');
    const userSinceSpan = document.getElementById('userSince');
    const newUsernameInput = document.getElementById('newUsername');
    const newEmailInput = document.getElementById('newEmail');
    const changeUsernameBtn = document.getElementById('changeUsernameBtn');
    const changeEmailBtn = document.getElementById('changeEmailBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const usernameMsg = document.getElementById('usernameMsg');
    const emailMsg = document.getElementById('emailMsg');

    emailSpan.textContent = currentUser.email;

    const createdAt = new Date(currentUser.created_at);
    userSinceSpan.textContent = createdAt.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });

    const { data: profile } = await supabase
      .from('users')
      .select('*')
      .eq('id', currentUser.id)
      .single();

    if (profile) {
      usernameSpan.textContent = profile.username || 'Not set';

      const premiumBadge = document.getElementById('premiumBadge');

      if (profile.is_premium) {
        document.querySelectorAll('.upgrade-access-btn, .upgrade-btn').forEach(btn => btn.remove());
        if (premiumBadge) premiumBadge.style.display = 'block';
      } else {
        if (premiumBadge) premiumBadge.style.display = 'none';
      }

      // Avatar logic
      const avatarUpload = document.getElementById('avatarUpload');
      const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
      const deleteAvatarBtn = document.getElementById('deleteAvatarBtn');
      const avatarMsg = document.getElementById('avatarMsg');
      const profilePreview = document.getElementById('profilePreview');

      if (profile.avatar_url) {
        profilePreview.src = `${profile.avatar_url}?t=${Date.now()}`;
      }

      uploadAvatarBtn?.addEventListener('click', () => {
        avatarUpload.click();
      });

      async function compressImage(file, maxWidth = 400, maxHeight = 400, quality = 0.85) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;

              if (width > height) {
                if (width > maxWidth) {
                  height *= maxWidth / width;
                  width = maxWidth;
                }
              } else {
                if (height > maxHeight) {
                  width *= maxHeight / height;
                  height = maxHeight;
                }
              }

              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              canvas.toBlob((blob) => {
                if (blob) {
                  resolve(new File([blob], file.name, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                  }));
                } else {
                  reject(new Error('Compression failed'));
                }
              }, 'image/jpeg', quality);
            };
            img.onerror = () => reject(new Error('Failed to load image'));
            img.src = e.target.result;
          };
          reader.onerror = () => reject(new Error('Failed to read file'));
          reader.readAsDataURL(file);
        });
      }

      avatarUpload?.addEventListener('change', async () => {
        const file = avatarUpload.files[0];
        if (!file || !currentUser) return;

        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
          avatarMsg.textContent = '‚ùå File too large. Max 5MB.';
          avatarMsg.style.color = '#ef4444';
          avatarMsg.style.background = 'rgba(239, 68, 68, 0.1)';
          avatarUpload.value = '';
          return;
        }

        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
        if (!validTypes.includes(file.type)) {
          avatarMsg.textContent = '‚ùå Invalid file type. Use JPG, PNG, or WebP.';
          avatarMsg.style.color = '#ef4444';
          avatarMsg.style.background = 'rgba(239, 68, 68, 0.1)';
          avatarUpload.value = '';
          return;
        }

        avatarMsg.textContent = '‚è≥ Processing...';
        avatarMsg.style.color = '#6366f1';
        avatarMsg.style.background = 'rgba(99, 102, 241, 0.1)';
        uploadAvatarBtn.disabled = true;

        try {
          const compressedFile = await compressImage(file, 400, 400, 0.85);
          const filePath = `${currentUser.id}.jpg`;

          avatarMsg.textContent = '‚è≥ Uploading...';

          const { error: uploadError } = await supabase.storage
            .from('avatars')
            .upload(filePath, compressedFile, {
              upsert: true,
              contentType: 'image/jpeg',
              cacheControl: '3600'
            });

          if (uploadError) {
            avatarMsg.textContent = '‚ùå Upload failed';
            avatarMsg.style.color = '#ef4444';
            avatarMsg.style.background = 'rgba(239, 68, 68, 0.1)';
            uploadAvatarBtn.disabled = false;
            return;
          }

          const { data } = supabase.storage
            .from('avatars')
            .getPublicUrl(filePath);

          const publicUrl = data.publicUrl;

          const { error: updateError } = await supabase
            .from('users')
            .update({ avatar_url: publicUrl })
            .eq('id', currentUser.id);

          if (!updateError) {
            profilePreview.src = `${publicUrl}?t=${Date.now()}`;
            avatarMsg.textContent = '‚úÖ Avatar updated!';
            avatarMsg.style.color = '#22c55e';
            avatarMsg.style.background = 'rgba(34, 197, 94, 0.1)';
          } else {
            avatarMsg.textContent = '‚ùå Failed to update profile';
            avatarMsg.style.color = '#ef4444';
            avatarMsg.style.background = 'rgba(239, 68, 68, 0.1)';
          }
        } catch (error) {
          avatarMsg.textContent = '‚ùå Failed to process image';
          avatarMsg.style.color = '#ef4444';
          avatarMsg.style.background = 'rgba(239, 68, 68, 0.1)';
        } finally {
          uploadAvatarBtn.disabled = false;
        }
      });

      deleteAvatarBtn?.addEventListener('click', async () => {
        if (!currentUser) return;

        avatarMsg.textContent = '‚è≥ Removing...';
        avatarMsg.style.color = '#6366f1';
        avatarMsg.style.background = 'rgba(99, 102, 241, 0.1)';
        deleteAvatarBtn.disabled = true;

        try {
          await supabase.storage
            .from('avatars')
            .remove([`${currentUser.id}.jpg`, `${currentUser.id}.png`, `${currentUser.id}.jpeg`]);

          const { error } = await supabase
            .from('users')
            .update({ avatar_url: null })
            .eq('id', currentUser.id);

          if (!error) {
            profilePreview.src = `assets/profile-icon.jpg?t=${Date.now()}`;
            avatarMsg.textContent = '‚úÖ Reverted to default avatar';
            avatarMsg.style.color = '#22c55e';
            avatarMsg.style.background = 'rgba(34, 197, 94, 0.1)';
          } else {
            avatarMsg.textContent = '‚ùå Failed to delete avatar';
            avatarMsg.style.color = '#ef4444';
            avatarMsg.style.background = 'rgba(239, 68, 68, 0.1)';
          }
        } finally {
          deleteAvatarBtn.disabled = false;
        }
      });
    }

    changeUsernameBtn?.addEventListener('click', async () => {
      const newUsername = newUsernameInput.value.trim();
      if (!newUsername) return;

      const { error } = await supabase
        .from('users')
        .update({ username: newUsername })
        .eq('id', currentUser.id);

      if (error) {
        usernameMsg.textContent = `‚ùå ${error.message}`;
        usernameMsg.style.color = '#ef4444';
        usernameMsg.style.background = 'rgba(239, 68, 68, 0.1)';
      } else {
        usernameMsg.textContent = '‚úÖ Username updated';
        usernameMsg.style.color = '#22c55e';
        usernameMsg.style.background = 'rgba(34, 197, 94, 0.1)';
        usernameSpan.textContent = newUsername;
        newUsernameInput.value = '';
      }
    });

    changeEmailBtn?.addEventListener('click', async () => {
      const newEmail = newEmailInput.value.trim();
      if (!newEmail) return;

      const { error } = await supabase.auth.updateUser({ email: newEmail });
      
      if (error) {
        emailMsg.textContent = `‚ùå ${error.message}`;
        emailMsg.style.color = '#ef4444';
        emailMsg.style.background = 'rgba(239, 68, 68, 0.1)';
      } else {
        emailMsg.textContent = '‚úÖ Confirmation email sent';
        emailMsg.style.color = '#22c55e';
        emailMsg.style.background = 'rgba(34, 197, 94, 0.1)';
        newEmailInput.value = '';
      }
    });

    logoutBtn?.addEventListener('click', async () => {
      try {
        const { error } = await supabase.auth.signOut();
        if (error) console.error('Supabase signOut error:', error);
        
        localStorage.clear();
        sessionStorage.clear();
        
        document.cookie.split(";").forEach((c) => {
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
        });
        
        window.location.href = 'index.html?logout=' + Date.now();
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = 'index.html?logout=' + Date.now();
      }
    });

  })();
</script>

</body>
</html>